<?php


    use DynamicalWeb\Actions;
    use DynamicalWeb\DynamicalWeb;
    use IntellivoidAccounts\Abstracts\AuditEventType;
    use IntellivoidAccounts\IntellivoidAccounts;
    use IntellivoidAccounts\Objects\Account;
    use TelegramClientManager\Abstracts\SearchMethods\TelegramClientSearchMethod;
    use TelegramClientManager\Exceptions\TelegramClientNotFoundException;

    if(isset($_GET['auth']))
    {
        if($_GET['auth'] == 'telegram')
        {
            if(isset($_GET['client_id']))
            {
                setupTelegramAuth();
            }
        }
    }

    function setupTelegramAuth()
    {
        /** @var Account $Account */
        $Account = DynamicalWeb::getMemoryObject('account');

        if($Account->Configuration->VerificationMethods->TelegramClientLinked == true)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security');
            $RequestHandler->execute();
        }

        /** @var IntellivoidAccounts $IntellivoidAccounts */
        $IntellivoidAccounts = DynamicalWeb::getMemoryObject('intellivoid_accounts');

        try
        {
            $TelegramClient = $IntellivoidAccounts->getTelegramClientManager()->getClient(
                TelegramClientSearchMethod::byPublicId, $_GET['client_id']
            );
        }
        catch (TelegramClientNotFoundException $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '109'
            ));
            $RequestHandler->execute();
        }
        catch(Exception $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '110'
            ));
            $RequestHandler->execute();
        }

        /** @noinspection PhpUndefinedVariableInspection */
        if($TelegramClient->AccountID !== null)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '111'
            ));
            $RequestHandler->execute();
        }

        if(isset($_GET["hash"]) == false)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '109', 'clause' => 'missing_hash'
            ));
            $RequestHandler->execute();
        }

        if(isset($_GET["verification_sign"]) == false)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '109', 'clause' => 'missing_verification'
            ));
            $RequestHandler->execute();
        }

        $VerificationSign = hash("sha256", $_GET["hash"] . $TelegramClient->ID);
        if($VerificationSign !== $_GET["verification_sign"])
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '109', 'clause' => 'bad_verification'
            ));
            $RequestHandler->execute();
        }

        $Account->Configuration->VerificationMethods->TelegramClientLinked = true;
        $Account->Configuration->VerificationMethods->TelegramLink->enable($TelegramClient->ID);
        $TelegramClient->AccountID = $Account->ID;

        try
        {
            $IntellivoidAccounts->getAccountManager()->updateAccount($Account);
        }
        catch(Exception $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '110'
            ));
            $RequestHandler->execute();
        }

        try
        {
            $IntellivoidAccounts->getAuditLogManager()->logEvent($Account->ID, AuditEventType::TelegramVerificationEnabled);
            $IntellivoidAccounts->getTelegramClientManager()->updateClient($TelegramClient, false, true);
            $IntellivoidAccounts->getTelegramService()->sendLinkedNotification($TelegramClient);
        }
        catch(Exception $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
                'callback' => '110'
            ));
            $RequestHandler->execute();
        }

        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('settings/login_security', array(
            'callback' => '112'
        ));
        $RequestHandler->execute();
    }