<?php

    use DynamicalWeb\DynamicalWeb;
    use IntellivoidAccounts\Abstracts\SearchMethods\AuthenticationAccessSearchMethod;
    use IntellivoidAccounts\Exceptions\AuthenticationAccessNotFoundException;
    use IntellivoidAccounts\IntellivoidAccounts;
    use IntellivoidAccounts\Objects\COA\Application;
    use IntellivoidAccounts\Objects\COA\AuthenticationRequest;

    if(isset($_GET['access_token']))
    {
        /** @var IntellivoidAccounts $IntellivoidAccounts */
        $IntellivoidAccounts = DynamicalWeb::getMemoryObject("intellivoid_accounts");

        /** @var Application $Application */
        $Application = DynamicalWeb::getMemoryObject('application');

        /** @var AuthenticationRequest $AuthenticationRequest */
        $AuthenticationRequest = DynamicalWeb::getMemoryObject('auth_request');

        try
        {
            $AccessToken = $IntellivoidAccounts->getCrossOverAuthenticationManager()->getAuthenticationAccessManager()->getAuthenticationAccess(AuthenticationAccessSearchMethod::byAccessToken, $_GET['access_token']);
        }
        catch (AuthenticationAccessNotFoundException $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '25')
            );
            $RequestHandler->execute();
        }
        catch(Exception $exception)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '-1')
            );
            $RequestHandler->execute();
        }

        if($AccessToken->ApplicationId !== $Application->ID)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '36')
            );
            $RequestHandler->execute();
        }

        if($AccessToken->RequestId !== $AuthenticationRequest->Id)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '37')
            );
            $RequestHandler->execute();
        }

        if($AccessToken->AccountId !== WEB_ACCOUNT_ID)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '38')
            );
            $RequestHandler->execute();
        }

        if((int)time() > $AccessToken->ExpiresTimestamp)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
                array('error_code' => '27')
            );
            $RequestHandler->execute();
        }

        DynamicalWeb::setMemoryObject('access_token', $AccessToken);

    }
    else
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('authentication/coa/application_error',
            array('error_code' => '24')
        );
        $RequestHandler->execute();
    }