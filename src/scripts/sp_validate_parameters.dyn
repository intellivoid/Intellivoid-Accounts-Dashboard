<?php

    use DynamicalWeb\DynamicalWeb;
    use IntellivoidAccounts\Abstracts\SearchMethods\ApplicationSearchMethod;
    use IntellivoidAccounts\Exceptions\ApplicationNotFoundException;
    use IntellivoidAccounts\IntellivoidAccounts;
    use IntellivoidSubscriptionManager\Abstracts\SearchMethods\SubscriptionPlanSearchMethod;
    use IntellivoidSubscriptionManager\Abstracts\SearchMethods\SubscriptionPromotionSearchMethod;
    use IntellivoidSubscriptionManager\Exceptions\SubscriptionPlanNotFoundException;
    use IntellivoidSubscriptionManager\Exceptions\SubscriptionPromotionNotFoundException;
    use IntellivoidSubscriptionManager\IntellivoidSubscriptionManager;
    use IntellivoidSubscriptionManager\Objects\Subscription\Properties;

    // Validate the parameters
    function validate_parameter_presence(string $parameter_name)
    {
        if(isset($_GET[$parameter_name]) == false)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
                'error_type' => 'missing_parameter',
                'parameter' => $parameter_name
            ]);
            $RequestHandler->execute();
        }
    }

    validate_parameter_presence('plan_name');
    validate_parameter_presence('access_token');
    validate_parameter_presence('transaction_token');
    validate_parameter_presence('subscription_plan_id');
    validate_parameter_presence('app_tag');

    if(isset($_GET['promotion_code']))
    {
        validate_parameter_presence('promotion_id');
    }

    if(isset($_GET['promotion_id']))
    {
        validate_parameter_presence('promotion_code');
    }

    if(DynamicalWeb::activeRequestHandler()->Redirect == true)
        return;


    // Validate the information
    if(isset(DynamicalWeb::$globalObjects["intellivoid_accounts"]) == false)
    {
        /** @var IntellivoidAccounts $IntellivoidAccounts */
        $IntellivoidAccounts = DynamicalWeb::setMemoryObject(
            "intellivoid_accounts", new IntellivoidAccounts()
        );
    }
    else
    {
        /** @var IntellivoidAccounts $IntellivoidAccounts */
        $IntellivoidAccounts = DynamicalWeb::getMemoryObject("intellivoid_accounts");
    }

    if(isset(DynamicalWeb::$globalObjects["subscription_manager"]) == false)
    {
        /** @var IntellivoidSubscriptionManager $SubscriptionManager */
        $SubscriptionManager = DynamicalWeb::setMemoryObject(
            "subscription_manager", new IntellivoidSubscriptionManager()
        );
    }
    else
    {
        /** @var IntellivoidSubscriptionManager $SubscriptionManager */
        $SubscriptionManager = DynamicalWeb::getMemoryObject("subscription_manager");
    }

    try
    {
        $Application = $IntellivoidAccounts->getApplicationManager()->getApplication(
            ApplicationSearchMethod::byId, $_GET['app_tag']
        );
    }
    catch (ApplicationNotFoundException $e)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'invalid_app_tag'
        ]);
        $RequestHandler->execute();
    }
    catch(Exception $e)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'internal_server_error',
            'step' => '1'
        ]);
        $RequestHandler->execute();
    }

    try
    {
        $SubscriptionPlan = $SubscriptionManager->getPlanManager()->getSubscriptionPlanByName(
            $Application->ID, $_GET['plan_name']
        );

        $SubscriptionPlanAlt = $SubscriptionManager->getPlanManager()->getSubscriptionPlan(
            SubscriptionPlanSearchMethod::byPublicId, $_GET['subscription_plan_id']
        );
    }
    catch (SubscriptionPlanNotFoundException $e)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'invalid_plan_name',
            'step' => '1'
        ]);
        $RequestHandler->execute();
    }
    catch(Exception $e)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'internal_server_error',
            'step' => '2'
        ]);
        $RequestHandler->execute();
    }

    if($SubscriptionPlan->PublicID !== $SubscriptionPlanAlt->PublicID)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'invalid_plan_name',
            'step' => '1'
        ]);
        $RequestHandler->execute();
    }

    if($SubscriptionPlan->ApplicationID !== $Application->ID)
    {
        $RequestHandler = DynamicalWeb::activeRequestHandler();
        $RequestHandler->Redirect = true;
        $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
            'error_type' => 'parameter_error',
            'error' => 'invalid_plan_name',
            'step' => '2'
        ]);
        $RequestHandler->execute();
    }

    if(isset($_GET['promotion_code']))
    {
        try
        {
            $SubscriptionPromotion = $SubscriptionManager->getPromotionManager()->getSubscriptionPromotion(
                SubscriptionPromotionSearchMethod::byPromotionCode, $_GET['promotion_code']
            );

            $SubscriptionManager->getPromotionManager()->getSubscriptionPromotion(
                SubscriptionPromotionSearchMethod::byPublicId, $_GET['promotion_id']
            );
        }
        catch (SubscriptionPromotionNotFoundException $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
                'error_type' => 'parameter_error',
                'error' => 'invalid_promotion_name',
                'step' => '2'
            ]);
            $RequestHandler->execute();
        }
        catch(Exception $e)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
                'error_type' => 'parameter_error',
                'error' => 'internal_server_error',
                'step' => '3'
            ]);
            $RequestHandler->execute();
        }

        if($SubscriptionPromotion->SubscriptionPlanID !== $SubscriptionPlan->ID)
        {
            $RequestHandler = DynamicalWeb::activeRequestHandler();
            $RequestHandler->Redirect = true;
            $RequestHandler->RedirectLocation = DynamicalWeb::getRoute('purchase_failure', [
                'error_type' => 'parameter_error',
                'error' => 'invalid_promotion_name',
                'step' => '3'
            ]);
            $RequestHandler->execute();
        }

        DynamicalWeb::setMemoryObject('subscription_promotion_set', true);
        DynamicalWeb::setMemoryObject('subscription_promotion', $SubscriptionPromotion);
    }
    else
    {
        DynamicalWeb::setMemoryObject('subscription_promotion_set', false);
    }

    $SubscriptionDetails = [
        'billing_cycle' => $SubscriptionPlan->BillingCycle,
        'plan_name' => $SubscriptionPlan->PlanName,
        'plan_id' => $SubscriptionPlan->PublicID,
        'features' => []
    ];

    $SubscriptionDetailsProperties = new Properties();

    foreach($SubscriptionPlan->Features as $feature)
    {
        $SubscriptionDetailsProperties->addFeature($feature);
    }

    if(isset($_GET['promotion_code']) == false)
    {
        $SubscriptionDetails['initial_price'] = $SubscriptionPlan->InitialPrice;
        $SubscriptionDetails['cycle_price'] = $SubscriptionPlan->CyclePrice;
    }
    else
    {
        $SubscriptionDetails['initial_price'] = $SubscriptionPromotion->InitialPrice;
        $SubscriptionDetails['cycle_price'] = $SubscriptionPromotion->CyclePrice;

        foreach($SubscriptionPromotion->Features as $feature)
        {
            $SubscriptionDetailsProperties->addFeature($feature);
        }

        $SubscriptionDetails['promotion_code'] = $SubscriptionPromotion->PromotionCode;
        $SubscriptionDetails['promotion_id'] = $SubscriptionPromotion->PublicID;
    }

    foreach($SubscriptionDetailsProperties->Features as $feature)
    {
        $SubscriptionDetails['features'][] = $feature->toArray();
    }

    DynamicalWeb::setMemoryObject('subscription_plan', $SubscriptionPlan);
    DynamicalWeb::setMemoryObject('application', $Application);
    DynamicalWeb::setMemoryObject('subscription_details', $SubscriptionDetails);